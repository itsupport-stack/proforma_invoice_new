<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proforma Invoice</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 14px;
            color: #333;
        }
        address { font-style: normal; }
        [contenteditable="true"] {
            display: inline-block; min-width: 50px; border-bottom: 1px dashed #c1d6e1;
            padding: 2px; outline: none; cursor: text; transition: all 0.2s;
        }
        [contenteditable="true"]:hover, [contenteditable="true"]:focus { border-bottom-color: #0a5e5e; background-color: #f0f8ff; }
        input, select {
            border: 1px solid #c1d6e1; padding: 2px 4px; border-radius: 4px; outline: none;
            transition: all 0.2s;
        }
        input:hover, select:hover, input:focus, select:focus { border-color: #0a5e5e; background-color: #f0f8ff; }
       
        /* Hide default dropdown arrow */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%230a5e5e" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
        }
       
        /* Message box styling */
        .message-box {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: #004343; color: white; padding: 1rem 2rem; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 1000; display: none;
            animation: fadeInOut 3s forwards; font-weight: 500;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateX(-50%) scale(0.9); }
            10%, 90% { opacity: 1; transform: translateX(-50%) scale(1); }
        }
       
        /* A4 Paper Optimization for printing */
        .invoice-container {
            width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height */
            margin: 0 auto;
            padding: 20mm;
            box-shadow: none;
        }
        .invoice-container, body { background-color: #ffffff; }

        /* Fix for state dropdown overflow */
        .address-select {
            max-width: calc(100% - 70px); /* Adjust based on label width */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Enforce a page break before the terms and conditions section */
        #terms-and-footer-page {
            page-break-before: always;
            padding-top: 20mm; /* Adjust padding for a clean start on the new page */
            position: relative;
        }

        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }
            body {
                margin: 0;
                font-size: 12px;
                color: #000;
            }
            .invoice-container {
                width: 100%;
                min-height: 0;
                padding: 0;
                box-shadow: none;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print, .add-remove-buttons { display: none !important; }
            .print-hide-if-empty.hidden-for-print { display: none !important; }
            [contenteditable="true"], input, select { border: none !important; background-color: transparent !important; padding: 0; }
            .delete-item-btn { display: none; }
           
            /* Hide dropdown arrows in print */
            select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                background-image: none;
            }
            /* Adjust input and span padding for print */
            .customer-info p > span, .customer-info input { padding: 0 !important; }

            /* Keep table header on every page */
            table { page-break-after: auto; }
            thead { display: table-header-group; }
           
            /* Prevent rows and footer from splitting across pages */
            tr, tfoot, .footer-content { page-break-inside: avoid; }
           
            /* Fix QR code print size */
            #qrcode { display: block !important; }
            #qrcode img {
                width: 100px !important;
                height: 100px !important;
            }
           
            /* Ensure the footer section is full-page on print */
            #terms-and-footer-page {
                height: auto;
                padding-top: 10mm;
                padding-bottom: 10mm;
            }
            #thank-you-message-print { display: block !important; }
           
            /* Vertically shorten the green border in print */
            .bank-details-block, .terms-block {
                height: auto; /* Allow height to be determined by content */
                display: flex;
                flex-direction: column;
            }
            .bank-details-content, .terms-content {
                flex-grow: 1; /* Allow content to grow, but border stays with content */
                border-left-width: 4px;
                border-color: #009a7b;
            }
           
            /* Remove margins that cause extra spacing */
            .bank-details-block, .terms-block { margin-bottom: 0 !important; }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#004343',
                        'secondary-dark': '#0a5e5e',
                        'primary-accent': '#009a7b',
                        'secondary-accent': '#11c99d',
                        'white-shade': '#ffffff',
                    },
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="message-box" id="messageBox"></div>
    <div id="invoice-wrapper" class="invoice-container bg-white shadow-lg relative">
       
        <header class="flex justify-between items-start mb-12">
            <div>
                <h1 contenteditable="true" class="text-4xl font-bold mb-1 text-primary-dark outline-none">PROFORMA INVOICE</h1>
                <p class="text-secondary-dark text-lg"><span contenteditable="true">Sub-title if any</span></p>
            </div>
            <div class="text-right">
                <h2 contenteditable="true" class="text-xl font-bold text-primary-dark">YOUR COMPANY NAME</h2>
                <address contenteditable="true" class="text-gray-600 mt-2 leading-relaxed">
                    [Your Address]<br>
                    [City, State, ZIP]<br>
                    [Phone Number]<br>
                    [Email Address]<br>
                    [GSTIN Number]<br>
                </address>
            </div>
        </header>

        <div class="flex justify-between mb-8">
            <div class="customer-info border-l-4 border-primary-accent pl-4">
                <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">BILL TO</h3>
                <h4 contenteditable="true" class="text-lg font-semibold text-primary-dark mb-1">Customer Name</h4>
                <address contenteditable="true" class="text-gray-600 leading-relaxed">
                    [Customer Address]<br>
                    [City, State, ZIP]<br>
                    [GSTIN Number]<br>
                </address>
                <div class="mt-2 text-gray-600 flex items-center">
                    <span class="mr-2">State:</span>
                    <select id="state-select" class="address-select p-1 border-b-2 border-dashed border-gray-300 bg-white" onchange="updatePlaceOfSupply()">
                        </select>
                </div>
            </div>
            <div class="text-right invoice-details border-r-4 border-primary-accent pr-4">
                <p class="mb-2"><span class="font-semibold text-primary-dark">Proforma Invoice No:</span> <span contenteditable="true" class="text-gray-600">PI-001</span></p>
                <p class="mb-2"><span class="font-semibold text-primary-dark">Date:</span> <span id="invoice-date" contenteditable="true" class="text-gray-600">24 Oct 2023</span></p>
                <p><span class="font-semibold text-primary-dark">Due Date:</span> <span id="due-date" contenteditable="true" class="text-gray-600">31 Oct 2023</span></p>
                <p class="mt-2 text-gray-600"><span class="font-semibold text-primary-dark">Place of Supply:</span> <span id="place-of-supply" class="text-gray-600"></span></p>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-primary-dark text-white text-sm uppercase">
                        <th class="p-3 font-semibold">S.No.</th>
                        <th class="p-3 font-semibold">Particulars</th>
                        <th class="p-3 font-semibold">Qty</th>
                        <th class="p-3 font-semibold">Rate</th>
                        <th class="p-3 font-semibold">Per</th>
                        <th class="p-3 font-semibold">Amount</th>
                        <th class="p-3 font-semibold no-print"></th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    <tr class="item-row bg-white hover:bg-gray-100 transition-colors">
                        <td class="p-3 border-b border-gray-200">1</td>
                        <td class="p-3 border-b border-gray-200">
                            <select class="particulars-dropdown w-full" style="padding: 0; border: none; background-color: transparent; outline: none;"></select>
                        </td>
                        <td class="p-3 border-b border-gray-200"><span contenteditable="true">10</span></td>
                        <td class="p-3 border-b border-gray-200">₹ <span contenteditable="true">100.00</span></td>
                        <td class="p-3 border-b border-gray-200"><span contenteditable="true">Unit</span></td>
                        <td class="p-3 border-b border-gray-200">₹ <span class="item-amount">1000.00</span></td>
                        <td class="p-3 border-b border-gray-200 no-print">
                            <button class="delete-item-btn text-red-500 hover:text-red-700 font-bold ml-2">X</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="add-remove-buttons text-center my-4 no-print">
            <button id="add-item-btn" class="bg-primary-accent text-white font-bold py-2 px-4 rounded-lg hover:bg-secondary-accent transition-colors">Add Item</button>
        </div>

        <div class="flex justify-end mt-8">
            <div class="w-full md:w-1/2 lg:w-1/3">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-primary-dark">Subtotal:</span>
                    <span class="text-lg font-bold text-gray-800">₹ <span id="subtotal">0.00</span></span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-primary-dark">Tax (<span contenteditable="true" id="tax-rate">18</span>%):</span>
                    <span class="text-lg font-bold text-gray-800">₹ <span id="tax-amount">0.00</span></span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t-2 border-primary-accent">
                    <span class="text-xl font-bold text-primary-dark">Total:</span>
                    <span class="text-2xl font-extrabold text-primary-accent">₹ <span id="grand-total">0.00</span></span>
                </div>
                <div id="words-amount" class="mt-4 text-gray-600 text-sm">Amount in Words: <span class="font-semibold" id="amount-in-words"></span></div>
            </div>
        </div>
       
        <div class="flex justify-between items-end mt-12 mb-8 no-print">
            <div id="qrcode"></div>
            <div class="text-center">
                <hr class="w-48 mx-auto my-2 border-t-2 border-gray-400">
                <p contenteditable="true" class="text-lg font-semibold text-primary-dark">Authorized Signatory</p>
            </div>
        </div>
       
        <div class="no-screen flex justify-between items-end mt-12 mb-8 hidden-for-print">
            <div id="qrcode-print"></div>
        </div>
       
        <div id="terms-and-footer-page">
            <div class="bank-details-block border-l-4 border-primary-accent pl-4 mb-8">
                <div class="bank-details-content">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">BANK DETAILS</h3>
                    <p class="text-gray-600 mb-1"><span class="font-semibold text-primary-dark">Bank Name:</span> <span contenteditable="true">[Bank Name]</span></p>
                    <p class="text-gray-600 mb-1"><span class="font-semibold text-primary-dark">Account Name:</span> <span contenteditable="true">[Account Name]</span></p>
                    <p class="text-gray-600 mb-1"><span class="font-semibold text-primary-dark">Account No:</span> <span contenteditable="true">[Account Number]</span></p>
                    <p class="text-gray-600 mb-1"><span class="font-semibold text-primary-dark">IFSC Code:</span> <span contenteditable="true">[IFSC Code]</span></p>
                </div>
            </div>

            <div class="terms-block border-l-4 border-primary-accent pl-4">
                <div class="terms-content">
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">TERMS & CONDITIONS</h3>
                    <ul contenteditable="true" class="list-disc list-inside text-gray-600 leading-relaxed">
                        <li>Payment is due within 7 days of the invoice date.</li>
                        <li>Please make all payments to the bank account specified above.</li>
                        <li>This is a computer-generated invoice and does not require a physical signature.</li>
                    </ul>
                </div>
            </div>
           
            <footer class="text-center text-gray-500 text-sm mt-8">
                <p id="thank-you-message" class="no-print">Thank you for your business!</p>
                <p id="thank-you-message-print" class="no-screen hidden-for-print text-primary-dark text-xl font-bold">Thank you for your business!</p>
            </footer>
        </div>
    </div>
   
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Function to update the invoice date and due date
            function setInvoiceDates() {
                const invoiceDate = new Date();
                const dueDate = new Date();
                dueDate.setDate(invoiceDate.getDate() + 7);
                document.getElementById('invoice-date').textContent = invoiceDate.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
                document.getElementById('due-date').textContent = dueDate.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric' });
            }

            // Function to get unique product names from the CSV
            async function getProductNames() {
                try {
                    const response = await fetch('product_master.csv');
                    const text = await response.text();
                    const rows = text.split('\n').slice(1); // Skip header row
                    const productNames = new Set();
                    rows.forEach(row => {
                        const columns = row.split(',');
                        if (columns[0]) {
                            productNames.add(columns[0].trim().replace(/"/g, ''));
                        }
                    });
                    return Array.from(productNames);
                } catch (error) {
                    console.error('Error fetching or parsing CSV:', error);
                    return [];
                }
            }

            // Function to populate a dropdown with product names
            function populateParticularsDropdown(dropdown, productNames) {
                dropdown.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select a product';
                dropdown.appendChild(defaultOption);
                productNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    dropdown.appendChild(option);
                });
            }

            // Function to calculate and update totals
            function updateTotals() {
                let subtotal = 0;
                document.querySelectorAll('.item-row').forEach(row => {
                    const quantity = parseFloat(row.querySelector('[contenteditable="true"]:nth-of-type(1)').textContent) || 0;
                    const rate = parseFloat(row.querySelector('[contenteditable="true"]:nth-of-type(2)').textContent) || 0;
                    const amount = quantity * rate;
                    row.querySelector('.item-amount').textContent = amount.toFixed(2);
                    subtotal += amount;
                });
                const taxRate = parseFloat(document.getElementById('tax-rate').textContent) || 0;
                const taxAmount = (subtotal * taxRate) / 100;
                const grandTotal = subtotal + taxAmount;
                document.getElementById('subtotal').textContent = subtotal.toFixed(2);
                document.getElementById('tax-amount').textContent = taxAmount.toFixed(2);
                document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
                updateAmountInWords(grandTotal);
            }

            // Function to add a new item row
            async function addItemRow() {
                const tableBody = document.getElementById('invoice-items');
                const rowCount = tableBody.querySelectorAll('.item-row').length;
                const newRow = document.createElement('tr');
                newRow.className = 'item-row bg-white hover:bg-gray-100 transition-colors';
                newRow.innerHTML = `
                    <td class="p-3 border-b border-gray-200">${rowCount + 1}</td>
                    <td class="p-3 border-b border-gray-200">
                        <select class="particulars-dropdown w-full" style="padding: 0; border: none; background-color: transparent; outline: none;"></select>
                    </td>
                    <td class="p-3 border-b border-gray-200"><span contenteditable="true">0</span></td>
                    <td class="p-3 border-b border-gray-200">₹ <span contenteditable="true">0.00</span></td>
                    <td class="p-3 border-b border-gray-200"><span contenteditable="true">Unit</span></td>
                    <td class="p-3 border-b border-gray-200">₹ <span class="item-amount">0.00</span></td>
                    <td class="p-3 border-b border-gray-200 no-print">
                        <button class="delete-item-btn text-red-500 hover:text-red-700 font-bold ml-2">X</button>
                    </td>
                `;
                tableBody.appendChild(newRow);
                updateRowNumbers();
                addEventListenersToRow(newRow);
                const dropdown = newRow.querySelector('.particulars-dropdown');
                const productNames = await getProductNames();
                populateParticularsDropdown(dropdown, productNames);
            }

            // Function to update row numbers
            function updateRowNumbers() {
                document.querySelectorAll('#invoice-items .item-row').forEach((row, index) => {
                    row.querySelector('td:first-child').textContent = index + 1;
                });
            }

            // Function to remove an item row
            function removeItemRow(button) {
                if (document.querySelectorAll('.item-row').length > 1) {
                    button.closest('.item-row').remove();
                    updateRowNumbers();
                    updateTotals();
                } else {
                    showMessage('Cannot delete the last row.', 'error');
                }
            }

            // Function to handle all events for a row
            function addEventListenersToRow(row) {
                row.querySelector('.delete-item-btn').addEventListener('click', (e) => removeItemRow(e.target));
                row.querySelectorAll('[contenteditable="true"]').forEach(el => {
                    el.addEventListener('input', updateTotals);
                });
                row.querySelector('.particulars-dropdown').addEventListener('change', updateTotals);
            }

            // State and Place of Supply Logic
            const indianStates = [
                "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Delhi", "Jammu and Kashmir", "Ladakh", "Lakshadweep", "Puducherry"
            ];
            const stateSelect = document.getElementById('state-select');
            indianStates.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });
            function updatePlaceOfSupply() {
                const selectedState = stateSelect.value;
                document.getElementById('place-of-supply').textContent = selectedState;
            }

            // Function for QR Code Generation
            function generateQRCode() {
                const data = "Placeholder QR Code Content. Replace with actual invoice data.";
                const qrcodeContainer = document.getElementById("qrcode");
                const qrcodeContainerPrint = document.getElementById("qrcode-print");
                if (qrcodeContainer) {
                    qrcodeContainer.innerHTML = '';
                    new QRCode(qrcodeContainer, {
                        text: data,
                        width: 100,
                        height: 100,
                        colorDark : "#004343",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }
                if (qrcodeContainerPrint) {
                    qrcodeContainerPrint.innerHTML = '';
                    new QRCode(qrcodeContainerPrint, {
                        text: data,
                        width: 100,
                        height: 100,
                        colorDark : "#004343",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }
            }
           
            // Word to number conversion for amount in words
            const a = ['','one ','two ','three ','four ', 'five ','six ','seven ','eight ','nine ','ten ','eleven ','twelve ','thirteen ','fourteen ','fifteen ','sixteen ','seventeen ','eighteen ','nineteen '];
            const b = ['', '', 'twenty','thirty','forty','fifty', 'sixty','seventy','eighty','ninety'];
            function inWords (num) {
                if ((num = num.toString()).length > 9) return 'overflow';
                n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
                if (!n) return; var str = '';
                str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
                str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
                str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
                str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
                str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) + 'only ' : '';
                return str.charAt(0).toUpperCase() + str.slice(1);
            }
            function updateAmountInWords(amount) {
                document.getElementById('amount-in-words').textContent = inWords(Math.floor(amount));
            }
           
            // Message box functionality
            function showMessage(msg, type) {
                const messageBox = document.getElementById('messageBox');
                messageBox.textContent = msg;
                messageBox.style.display = 'block';
                // You can add more styling here for 'error' type
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 3000);
            }
           
            // Initial setup
            setInvoiceDates();
            updatePlaceOfSupply();
            generateQRCode();
            updateTotals();
            document.getElementById('add-item-btn').addEventListener('click', addItemRow);
           
            // Add event listeners to the default row
            const firstRow = document.querySelector('.item-row');
            if (firstRow) {
                addEventListenersToRow(firstRow);
            }
            
            // Populate the dropdown for the first row on load
            const firstDropdown = firstRow.querySelector('.particulars-dropdown');
            if (firstDropdown) {
                getProductNames().then(productNames => {
                    populateParticularsDropdown(firstDropdown, productNames);
                });
            }

            // Event listener for tax rate input
            document.getElementById('tax-rate').addEventListener('input', updateTotals);

        });
    </script>
</body>
</html>
